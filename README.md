# Git Cherry Picker

Инструмент для автоматизированного `cherry-pick` коммитов по списку
задач в хронологическом порядке (от старых к новым) с интерактивной
обработкой конфликтов.

Теперь поддерживается автоматическая загрузка списка задач из JIRA для
выбранного релиза.

------------------------------------------------------------------------

## Состав

-   `git_cherry_picker.py` --- основной Python-скрипт (логика
    cherry-pick не изменялась)
-   `jira-connect.py` --- автоматически собирает задачи для указанного
    релиза из JIRA
-   `git_find.sh` --- массовый запуск по нескольким репозиториям
-   `tasks.txt` --- автоматически генерируемый список задач

------------------------------------------------------------------------

## Новый workflow (через JIRA)

1.  Указать версию релиза в `git_find.sh`
2.  Запустить `git_find.sh`
3.  Скрипт:
    -   устанавливает зависимости
    -   получает список задач из JIRA
    -   генерирует `tasks.txt`
    -   выполняет cherry-pick по всем репозиториям
4.  Разрешить конфликты (если появятся)
5.  Проверить ветки `release/<version>`

------------------------------------------------------------------------

## Настройка JIRA

Создайте `.env` файл в корне проекта:

    JIRA_TOKEN=your_personal_token_here
    PROJECT_ID=24108
    JIRA_SERVER=https://jira.mts.ru

### Параметры

-   `JIRA_TOKEN` --- персональный API токен
-   `PROJECT_ID` --- ID проекта в JIRA
-   `JIRA_SERVER` --- URL сервера JIRA

------------------------------------------------------------------------

## Массовый запуск

Пример `git_find.sh`:

``` bash
RELEASE_VER="1.2.1"
SOURCE_BRANCH="test"
TARGET_BRANCH="pre-prod"

REPOS=(
  "../eco-backend/"
  "../eco-auth/"
  "../eco-notifications/"
  "../airflow/"
  "../rpn-handler/"
)

pip install -r requirements.txt
python3 jira-connect.py $RELEASE_VER

for REPO in "${REPOS[@]}"; do
    if [ -d "$REPO" ]; then
        echo "Обработка репозитория: $REPO"
        python3 git_cherry_picker.py "$SOURCE_BRANCH" "$TARGET_BRANCH" tasks.txt --release="$RELEASE_VER" --repo-dir="$REPO"
        echo "----------------------------------------"
    else
        echo "ВНИМАНИЕ: Директория $REPO не существует, пропускаем"
    fi
done
```

------------------------------------------------------------------------

## Как работает git_cherry_picker.py

1.  Получает список задач (из `tasks.txt`)
2.  Находит коммиты в `source` ветке по `--grep`
3.  Исключает merge-коммиты
4.  Сортирует коммиты по времени
5.  Показывает список
6.  После подтверждения:
    -   переключается на `target`
    -   делает `pull`
    -   создаёт ветку `release/<version>`
    -   выполняет `git cherry-pick`
7.  При конфликте запускается интерактивное меню

------------------------------------------------------------------------

## Форматы задач

Поддерживаются:

    ECOLOGY-2994
    [ECOLOGY-2994]
    #1234

------------------------------------------------------------------------

## Dry-run

    python3 git_cherry_picker.py develop main tasks.txt --release=1.2.1 --dry-run

------------------------------------------------------------------------

## Параметры git_cherry_picker.py

  Параметр     Описание
  ------------ -----------------------------
  source       Исходная ветка
  target       Целевая ветка
  tasks        Список задач или файл
  --release    Версия релиза (обязательно)
  --repo-dir   Путь к репозиторию
  --dry-run    Только показать коммиты
  --verbose    Подробный вывод

------------------------------------------------------------------------

## Обработка конфликтов

Меню действий при конфликте:

    (d)iff     — показать diff
    (l)ist     — список конфликтных файлов
    (c)ontinue — продолжить
    (u)ours    — взять изменения из текущей ветки
    (t)heirs   — взять изменения из коммита
    (m)anual   — открыть редактор
    (s)kip     — пропустить коммит
    (a)bort    — отменить процесс

После разрешения выполняется:

    git cherry-pick --continue --no-edit

------------------------------------------------------------------------

## Требования

-   Python 3.8+
-   Git
-   Доступ к JIRA API
-   Чистое рабочее дерево
